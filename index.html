<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Votes - AG Extraordinaire</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const Download = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
        );

        const Upload = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
            </svg>
        );

        const Trash2 = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
        );

        const Search = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
        );

        const FileText = () => (
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
            </svg>
        );

        const BarChart3 = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>
            </svg>
        );

        function GestionVotesAG() {
            const [votes, setVotes] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [showStats, setShowStats] = useState(false);

            // Charger les données depuis localStorage au démarrage
            useEffect(() => {
                const savedVotes = localStorage.getItem('votesAG');
                if (savedVotes) {
                    try {
                        setVotes(JSON.parse(savedVotes));
                    } catch (e) {
                        console.error('Erreur lors du chargement des votes:', e);
                    }
                }
            }, []);

            // Sauvegarder les données dans localStorage à chaque modification
            useEffect(() => {
                localStorage.setItem('votesAG', JSON.stringify(votes));
            }, [votes]);

            const ajouterVote = () => {
                const nouveauVote = {
                    date: new Date().toISOString(),
                    nom: '',
                    prenom: '',
                    email: '',
                    type: 'Vote',
                    choix: '',
                    mandataire: '',
                    numero: genererNumero(),
                    commentaires: ''
                };
                setVotes([nouveauVote, ...votes]);
            };

            const genererNumero = () => {
                const date = new Date();
                const dateStr = date.toISOString().slice(2, 10).replace(/-/g, '');
                const timeStr = date.toTimeString().slice(0, 8).replace(/:/g, '');
                const random = Math.floor(Math.random() * 1000);
                return `AG-${dateStr}-${timeStr}-${random}`;
            };

            const supprimerVote = (index) => {
                if (window.confirm('Êtes-vous sûr de vouloir supprimer cette entrée ?')) {
                    setVotes(votes.filter((_, i) => i !== index));
                }
            };

            const modifierVote = (index, champ, valeur) => {
                const nouveauxVotes = [...votes];
                nouveauxVotes[index][champ] = valeur;
                setVotes(nouveauxVotes);
            };

            const exporterExcel = () => {
                const donnees = votes.map(v => ({
                    'Date': new Date(v.date).toLocaleString('fr-FR'),
                    'Nom': v.nom,
                    'Prénom': v.prenom,
                    'Email': v.email,
                    'Type': v.type,
                    'Choix/Vote': v.type === 'Vote' ? v.choix : 'Procuration',
                    'Mandataire': v.mandataire || '',
                    'Numéro': v.numero,
                    'Commentaires': v.commentaires
                }));

                const ws = XLSX.utils.json_to_sheet(donnees);
                
                const wscols = [
                    { wch: 18 }, { wch: 20 }, { wch: 15 }, { wch: 30 },
                    { wch: 12 }, { wch: 15 }, { wch: 20 }, { wch: 25 }, { wch: 30 }
                ];
                ws['!cols'] = wscols;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Votes AG Extraordinaire');
                XLSX.writeFile(wb, `votes_ag_extraordinaire_${new Date().toISOString().slice(0, 10)}.xlsx`);
            };

            const importerExcel = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    const votesImportes = jsonData.map(row => ({
                        date: row.Date || new Date().toISOString(),
                        nom: row.Nom || '',
                        prenom: row.Prénom || '',
                        email: row.Email || '',
                        type: row.Type || 'Vote',
                        choix: row['Choix/Vote'] === 'Procuration' ? '' : (row['Choix/Vote'] || ''),
                        mandataire: row.Mandataire || '',
                        numero: row.Numéro || genererNumero(),
                        commentaires: row.Commentaires || ''
                    }));

                    setVotes(votesImportes);
                };
                reader.readAsArrayBuffer(file);
            };

            const calculerStats = () => {
                const total = votes.length;
                const votesDirects = votes.filter(v => v.type === 'Vote').length;
                const procurations = votes.filter(v => v.type === 'Procuration').length;
                const pour = votes.filter(v => v.type === 'Vote' && v.choix === 'POUR').length;
                const contre = votes.filter(v => v.type === 'Vote' && v.choix === 'CONTRE').length;
                const abstention = votes.filter(v => v.type === 'Vote' && v.choix === 'ABSTENTION').length;

                return { total, votesDirects, procurations, pour, contre, abstention };
            };

            const stats = calculerStats();
            const votesFiltres = votes.filter(v =>
                v.nom.toLowerCase().includes(searchTerm.toLowerCase()) ||
                v.prenom.toLowerCase().includes(searchTerm.toLowerCase()) ||
                v.email.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
                            <div className="flex items-center justify-between mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                        Gestion des Votes - AG Extraordinaire
                                    </h1>
                                    <p className="text-gray-600">
                                        AG du 26 octobre 2025 - Procédure judiciaire assainissement
                                    </p>
                                </div>
                                <FileText />
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                    <div className="text-sm text-blue-600 font-medium mb-1">Total participations</div>
                                    <div className="text-3xl font-bold text-blue-800">{stats.total}</div>
                                    <div className="text-xs text-blue-600 mt-1">
                                        {stats.votesDirects} votes • {stats.procurations} procurations
                                    </div>
                                </div>
                                <div className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                    <div className="text-sm text-green-600 font-medium mb-1">Pour</div>
                                    <div className="text-3xl font-bold text-green-800">{stats.pour}</div>
                                    <div className="text-xs text-green-600 mt-1">
                                        {stats.total > 0 ? Math.round((stats.pour / stats.total) * 100) : 0}% du total
                                    </div>
                                </div>
                                <div className="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg border border-red-200">
                                    <div className="text-sm text-red-600 font-medium mb-1">Contre</div>
                                    <div className="text-3xl font-bold text-red-800">{stats.contre}</div>
                                    <div className="text-xs text-red-600 mt-1">
                                        {stats.total > 0 ? Math.round((stats.contre / stats.total) * 100) : 0}% du total
                                    </div>
                                </div>
                            </div>

                            {showStats && (
                                <div className="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center">
                                        <BarChart3 />
                                        <span className="ml-2">Statistiques détaillées</span>
                                    </h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                        <div>
                                            <span className="text-gray-600">Votes directs :</span>
                                            <span className="font-semibold ml-2">{stats.votesDirects}</span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Procurations :</span>
                                            <span className="font-semibold ml-2">{stats.procurations}</span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Abstentions :</span>
                                            <span className="font-semibold ml-2">{stats.abstention}</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="flex flex-wrap gap-3 mb-6">
                                <button
                                    onClick={ajouterVote}
                                    className="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition font-medium"
                                >
                                    + Ajouter une participation
                                </button>
                                <button
                                    onClick={exporterExcel}
                                    className="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition font-medium flex items-center"
                                    disabled={votes.length === 0}
                                >
                                    <Download />
                                    <span className="ml-2">Exporter Excel</span>
                                </button>
                                <label className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition font-medium flex items-center cursor-pointer">
                                    <Upload />
                                    <span className="ml-2">Importer Excel</span>
                                    <input
                                        type="file"
                                        accept=".xlsx,.xls"
                                        onChange={importerExcel}
                                        className="hidden"
                                    />
                                </label>
                                <button
                                    onClick={() => setShowStats(!showStats)}
                                    className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition font-medium flex items-center"
                                >
                                    <BarChart3 />
                                    <span className="ml-2">{showStats ? 'Masquer' : 'Afficher'} stats</span>
                                </button>
                            </div>

                            <div className="mb-4">
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                        <Search />
                                    </div>
                                    <input
                                        type="text"
                                        placeholder="Rechercher par nom, prénom ou email..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {votesFiltres.length === 0 && votes.length === 0 && (
                                <div className="bg-white rounded-xl shadow-lg p-8 text-center text-gray-500">
                                    Aucune participation enregistrée. Cliquez sur "Ajouter une participation" pour commencer.
                                </div>
                            )}
                            
                            {votesFiltres.length === 0 && votes.length > 0 && (
                                <div className="bg-white rounded-xl shadow-lg p-8 text-center text-gray-500">
                                    Aucun résultat trouvé pour "{searchTerm}"
                                </div>
                            )}

                            {votesFiltres.map((vote, index) => (
                                <div key={index} className="bg-white rounded-xl shadow-lg p-6">
                                    <div className="flex justify-between items-start mb-4">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-3 mb-2">
                                                <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                                    vote.type === 'Vote' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'
                                                }`}>
                                                    {vote.type}
                                                </span>
                                                {vote.type === 'Vote' && vote.choix && (
                                                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                                        vote.choix === 'POUR' ? 'bg-green-100 text-green-800' :
                                                        vote.choix === 'CONTRE' ? 'bg-red-100 text-red-800' :
                                                        'bg-gray-100 text-gray-800'
                                                    }`}>
                                                        {vote.choix}
                                                    </span>
                                                )}
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                {new Date(vote.date).toLocaleString('fr-FR')} - {vote.numero}
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => supprimerVote(index)}
                                            className="text-red-600 hover:bg-red-50 p-2 rounded-lg transition"
                                        >
                                            <Trash2 />
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Nom *</label>
                                            <input
                                                type="text"
                                                value={vote.nom}
                                                onChange={(e) => modifierVote(index, 'nom', e.target.value)}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                                placeholder="Nom"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Prénom *</label>
                                            <input
                                                type="text"
                                                value={vote.prenom}
                                                onChange={(e) => modifierVote(index, 'prenom', e.target.value)}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                                placeholder="Prénom"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                            <input
                                                type="email"
                                                value={vote.email}
                                                onChange={(e) => modifierVote(index, 'email', e.target.value)}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                                placeholder="email@example.com"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                                            <select
                                                value={vote.type}
                                                onChange={(e) => modifierVote(index, 'type', e.target.value)}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            >
                                                <option value="Vote">Vote</option>
                                                <option value="Procuration">Procuration</option>
                                            </select>
                                        </div>

                                        {vote.type === 'Vote' && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Vote *</label>
                                                <select
                                                    value={vote.choix}
                                                    onChange={(e) => modifierVote(index, 'choix', e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                                >
                                                    <option value="">Sélectionner...</option>
                                                    <option value="POUR">POUR</option>
                                                    <option value="CONTRE">CONTRE</option>
                                                    <option value="ABSTENTION">ABSTENTION</option>
                                                </select>
                                            </div>
                                        )}

                                        {vote.type === 'Procuration' && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Mandataire *</label>
                                                <input
                                                    type="text"
                                                    value={vote.mandataire}
                                                    onChange={(e) => modifierVote(index, 'mandataire', e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                                    placeholder="Nom Prénom du mandataire"
                                                />
                                            </div>
                                        )}

                                        <div className="md:col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Commentaires</label>
                                            <textarea
                                                value={vote.commentaires}
                                                onChange={(e) => modifierVote(index, 'commentaires', e.target.value)}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                                rows="2"
                                                placeholder="Commentaires optionnels..."
                                            />
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GestionVotesAG />);
    </script>
</body>
</html>
